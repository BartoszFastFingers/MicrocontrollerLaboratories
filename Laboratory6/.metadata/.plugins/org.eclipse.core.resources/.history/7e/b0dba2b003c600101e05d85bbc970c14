/*
 * BMP280.c
 *
 *  Created on: Nov 19, 2025
 *      Author: barte
 */


#include "BMP280.h"


#define BMP280_SPI_READ 	0x80
#define BMP280_SPI_WRITE	0x7F

#define BMP280_DIG_T1_LSB	0x88
#define BMP280_DIG_T1_MSB	0x89
#define BMP280_DIG_T2_LSB	0x8A
#define BMP280_DIG_T2_MSB	0x8B
#define BMP280_DIG_T3_LSB	0x8C
#define BMP280_DIG_T3_MSB	0x8D

#define BMP280_DIG_P1_LSB	0X8E
#define BMP280_DIG_P1_MSB	0x8F
#define BMP280_DIG_P2_LSB	0x90
#define BMP280_DIG_P2_MSB	0x91
#define BMP280_DIG_P3_LSB	0x92
#define BMP280_DIG_P3_MSB	0x93
#define BMP280_DIG_P4_LSB	0x94
#define BMP280_DIG_P4_MSB	0x95
#define BMP280_DIG_P5_LSB	0x96
#define BMP280_DIG_P5_MSB	0x97
#define BMP280_DIG_P6_LSB 	0x98
#define BMP280_DIG_P6_MSB	0x99
#define BMP280_DIG_P7_LSB 	0x9A
#define BMP280_DIG_P7_MSB	0x9B
#define BMP280_DIG_P8_LSB	0x9C
#define BMP280_DIG_P8_MSB	0x9D
#define BMP280_DIG_P9_LSB	0x9E
#define BMP280_DIG_P9_MSB	0x9F

static const uint8_t REG_PRESSURE_TAB[] =
{
	BMP280_DIG_P1_LSB,
	BMP280_DIG_P1_MSB,
	BMP280_DIG_P2_LSB,
	BMP280_DIG_P2_MSB,
	BMP280_DIG_P3_LSB,
	BMP280_DIG_P3_MSB,
	BMP280_DIG_P4_LSB,
	BMP280_DIG_P4_MSB,
	BMP280_DIG_P5_LSB,
	BMP280_DIG_P5_MSB,
	BMP280_DIG_P6_LSB,
	BMP280_DIG_P6_MSB,
	BMP280_DIG_P7_LSB,
	BMP280_DIG_P7_MSB,
	BMP280_DIG_P8_LSB,
	BMP280_DIG_P8_MSB,
	BMP280_DIG_P9_LSB,
	BMP280_DIG_P9_MSB
};

uint8_t BMP280_ReadReg(BMP280* bmp, uint8_t reg) {
      uint8_t tx[2];
      uint8_t rx[2];

      tx[0] = reg | BMP280_SPI_READ;
      tx[1] = 0x00;

      HAL_GPIO_WritePin(bmp->cs.port, bmp->cs.pin, GPIO_PIN_RESET);
      HAL_SPI_TransmitReceive(bmp->spi, tx, rx, 2, HAL_MAX_DELAY);
      HAL_GPIO_WritePin(bmp->cs.port, bmp->cs.pin, GPIO_PIN_SET);

      return rx[1];
}

void BMP280_WriteReg(BMP280* bmp, uint8_t reg, uint8_t value) {
      uint8_t tx[2];

      tx[0] = reg & BMP280_SPI_WRITE;
      tx[1] = value;

      HAL_GPIO_WritePin(bmp->cs.port, bmp->cs.pin, GPIO_PIN_RESET);
      HAL_SPI_Transmit(bmp->spi, tx, 2, HAL_MAX_DELAY);
      HAL_GPIO_WritePin(bmp->cs.port, bmp->cs.pin, GPIO_PIN_SET);
}


void BMP280_setSleep_mode(BMP280* bmp)
{
	BMP280_WriteReg(bmp, BMP_CTRL_MEAS, 0x00);
}

void BMP280_setStandard_mode(BMP280* bmp)
{
	BMP280_WriteReg(bmp, BMP_CTRL_MEAS, 0x4B);
}

void BMP280_setPeriod_oneSecond_wihoutFiler(BMP280* bmp)
{
	BMP280_WriteReg(bmp, BMP_CONFIG, 0xA0);
}

void BMP280_setPeriod_quarterSecond_wihoutFiler(BMP280* bmp)
{
	BMP280_WriteReg(bmp, BMP_CONFIG, 0x60);
}

void BMP280_readTempCalibration(BMP280* bmp)
{
    uint8_t lsb, msb;

    lsb = BMP280_ReadReg(bmp, BMP280_DIG_T1_LSB);
    msb = BMP280_ReadReg(bmp, BMP280_DIG_T1_MSB);

    bmp->dig_T[0] = (uint16_t)(msb << 8 | lsb);

    lsb = BMP280_ReadReg(bmp, BMP280_DIG_T2_LSB);
    msb = BMP280_ReadReg(bmp, BMP280_DIG_T2_MSB);
    bmp->dig_T[1] = (int16_t)(msb << 8 | lsb);

    lsb = BMP280_ReadReg(bmp, BMP280_DIG_T3_LSB);
    msb = BMP280_ReadReg(bmp, BMP280_DIG_T3_MSB);
    bmp->dig_T[2] = (int16_t)(msb << 8 | lsb);

}

void BMP280_readPressureCalibration(BMP280* bmp)
{
    uint8_t lsb, msb;

    lsb = BMP280_ReadReg(bmp, BMP280_DIG_P1_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P1_MSB);
        bmp->dig_P[0] = (uint16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P2_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P2_MSB);
        bmp->dig_P[1] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P3_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P3_MSB);
        bmp->dig_P[2] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P4_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P4_MSB);
        bmp->dig_P[3] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P5_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P5_MSB);
        bmp->dig_P[4] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P6_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P6_MSB);
        bmp->dig_P[5] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P7_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P7_MSB);
        bmp->dig_P[6] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P8_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P8_MSB);
        bmp->dig_P[7] = (int16_t)(msb << 8 | lsb);

        lsb = BMP280_ReadReg(bmp, BMP280_DIG_P9_LSB);
        msb = BMP280_ReadReg(bmp, BMP280_DIG_P9_MSB);
        bmp->dig_P[8] = (int16_t)(msb << 8 | lsb);
}

void BMP280_readFullCalibration(BMP280* bmp)
{
	BMP280_readTempCalibration(bmp);
	BMP280_readPressureCalibration(bmp);
}

void BMP280_init(BMP280* bmp, SPI_HandleTypeDef* spi,GPIO_TypeDef* gp_port, uint16_t gp_pin)
{
	bmp->spi = spi;
	bmp->cs.port = gp_port;
	bmp->cs.pin = gp_pin;
}

void BMP280_fast_temp_continous_measurment(BMP280* bmp)
{
	BMP280_setSleep_mode(bmp);
	//BMP280_setPeriod_oneSecond_wihoutFiler(bmp);
	BMP280_setStandard_mode(bmp);
}

int32_t BMP280_read_temp_raw(BMP280* bmp)
{
    uint8_t msb = BMP280_ReadReg(bmp, BMP_TEMP_MSB);
    uint8_t lsb = BMP280_ReadReg(bmp, BMP_TEMP_LSB);
    uint8_t xlsb = BMP280_ReadReg(bmp, BMP_TEMP_XLSB);

    int32_t raw_temp = ((int32_t)msb << 12) | ((int32_t)lsb << 4) | ((int32_t)(xlsb >> 4) & 0x0F);
    return raw_temp;
}

int32_t BMP280_read_pressure_raw(BMP280* bmp)
{
	uint8_t msb = BMP280_ReadReg(bmp, BMP_PRESS_MSB);
	uint8_t lsb = BMP280_ReadReg(bmp, BMP_PRESS_LSB);
	uint8_t xlsb = BMP280_ReadReg(bmp, BMP_PRESS_XLSB);

	int32_t raw_press = ((uint32_t)msb << 12) | ((uint32_t)lsb << 4) | ((uint32_t)(xlsb >> 4) & 0x0F );
	return raw_press;
}




float BMP280_read_temperature(BMP280* bmp)
{
    int32_t adc_T = BMP280_read_temp_raw(bmp);

    int32_t var1, var2;

    var1 = ((((adc_T >> 3) - ((int32_t)bmp->dig_T[0] << 1))) *
            ((int32_t)bmp->dig_T[1])) >> 11;

    var2 = (((((adc_T >> 4) - ((int32_t)bmp->dig_T[0])) *
              ((adc_T >> 4) - ((int32_t)bmp->dig_T[0]))) >> 12) *
            ((int32_t)bmp->dig_T[2])) >> 14;

    bmp->t_fine = var1 + var2;

    int32_t T = (bmp->t_fine * 5 + 128) >> 8;  // 0.01Â°C

    return T / 100.0f;
}


float BMP280_read_pressure(BMP280* bmp)
{
    int32_t adc_P = BMP280_read_pressure_raw(bmp);

    int64_t var1, var2, p;

    var1 = ((int64_t)bmp->t_fine) - 128000;
    var2 = var1 * var1 * (int64_t)bmp->dig_P[5];
    var2 = var2 + ((var1 * (int64_t)bmp->dig_P[4]) << 17);
    var2 = var2 + (((int64_t)bmp->dig_P[3]) << 35);

    var1 = ((var1 * var1 * (int64_t)bmp->dig_P[2]) >> 8) +
           ((var1 * (int64_t)bmp->dig_P[1]) << 12);

    var1 = (((((int64_t)1) << 47) + var1) * (int64_t)bmp->dig_P[0]) >> 33;

    if (var1 == 0) {
        return 0.0f;
    }

    p = 1048576 - adc_P;
    p = (((p << 31) - var2) * 3125) / var1;

    var1 = ((int64_t)bmp->dig_P[8] * (p >> 13) * (p >> 13)) >> 25;         // dig_P9
    var2 = ((int64_t)bmp->dig_P[7] * p) >> 19;                             // dig_P8

    p = ((p + var1 + var2) >> 8) + (((int64_t)bmp->dig_P[6]) << 4);        // dig_P7

    float press = (float)p / 256.0f;

    return press;
}


